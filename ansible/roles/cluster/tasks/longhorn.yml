- name: Check dependencies
  ansible.builtin.include_tasks: dependencies.yml

- name: Taint the control plane node to avoid it being used for longhorn storage
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Node
      metadata:
        name: "{{ k3s_control_plane }}"
      spec:
        taints:
          - key: node-role.kubernetes.io/master
            effect: NoSchedule

- name: Get the longhorn CLI tool
  ansible.builtin.get_url:
    url: "{{ cluster_longhorn_cli_tool }}"
    dest: /usr/local/bin/longhornctl
    mode: "0755"
  become: true

- name: Check for prerequisites
  ansible.builtin.shell: >
    KUBECONFIG=~/.kube/config
    longhornctl check preflight
  register: longhorn_check
  changed_when: false

- name: Install longhorn prerequisites
  ansible.builtin.shell: >
    KUBECONFIG=~/.kube/config
    longhornctl install preflight
  when: longhorn_check.stderr is search("error:")
  changed_when: true

- name: Install longhorn Helm Chart
  kubernetes.core.helm:
    chart_repo_url: https://charts.longhorn.io
    chart_ref: longhorn
    release_name: longhorn
    create_namespace: true
    namespace: longhorn-system
    state: present

# TODO
# create a credential secret
# USER=<USERNAME_HERE>; PASSWORD=<PASSWORD_HERE>; echo "${USER}:$(openssl passwd -stdin -apr1 <<< ${PASSWORD})" >> auth
# kubectl create secret generic -n longhorn-system basic-auth --from-file=auth

- name: Create a longhorn ingress
  kubernetes.core.k8s:
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: longhorn-ingress
        namespace: longhorn-system
        annotations:
          # type of authentication
          nginx.ingress.kubernetes.io/auth-type: basic
          # prevent the controller from redirecting (308) to HTTPS
          nginx.ingress.kubernetes.io/ssl-redirect: "false"
          # name of the secret that contains the user/password definitions
          nginx.ingress.kubernetes.io/auth-secret: basic-auth
          # message to display with an appropriate context why the authentication is required
          nginx.ingress.kubernetes.io/auth-realm: "Authentication Required "
          # custom max body size for file uploading like backing image uploading
          nginx.ingress.kubernetes.io/proxy-body-size: 10000m
          # base the root of the app at /longhorn
          nginx.ingress.kubernetes.io/rewrite-target: /$2
          nginx.ingress.kubernetes.io/use-regex: "true"
      spec:
        ingressClassName: nginx
        rules:
          - host: node01.lan
            http:
              paths:
                - backend:
                    service:
                      name: longhorn-frontend
                      port:
                        number: 80
                  path: /longhorn($|/)(.*)
                  pathType: Prefix
      when: longhorn_check.stderr is search("error:")
