# - name: Prepare ingress settings
#   ansible.builtin.set_fact:
#     dashboard_ingress_values:
#       app:
#         ingress:
#           enabled: true
#           ingressClassName: nginx
#           useDefaultIngressClass: true
#           pathType: Prefix
#           hosts:
#             - "{{ k3s_cluster_domain }}"
#             - localhost
#           path: /dashboard
#   when: "'ingress' in install_list"

- name: Install K8S Dashboard using helm
  kubernetes.core.helm:
    chart_repo_url: https://kubernetes.github.io/dashboard/
    chart_ref: kubernetes-dashboard
    release_name: kubernetes-dashboard
    create_namespace: true
    namespace: kubernetes-dashboard
    state: present
    # https://github.dev/kubernetes/dashboard/blob/master/charts/kubernetes-dashboard/values.yaml
    values: "{{ dashboard_ingress_values | default({}) }}"

- name: Create a service account for the dashboard
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: dashboard-admin
        namespace: kubernetes-dashboard

- name: Create a cluster role binding for the dashboard
  kubernetes.core.k8s:
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: dashboard-admin
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
        - kind: ServiceAccount
          name: dashboard-admin
          namespace: kubernetes-dashboard

- name: Create dashboard connection script
  ansible.builtin.copy:
    dest: "{{ bin_dir }}/dashboard.sh"
    content: |
      #!/bin/bash

      # Start a port-forward to the dashboard and background it
      nohup kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy 8443:443 &> /tmp/k8s-dash-proxy.out &

      # Get the token for the dashboard
      kubectl -n kubernetes-dashboard create token dashboard-admin

      echo
      echo Dashboard will be available using above token at:
      echo   https://localhost:8443
    mode: "0755"
