# this seems a little cheesy but I don't know a reliable way to connect to the node
# we just created. This can reliably update the filesystem on the node to apply
# the changes we need to make, including giving the node a new hostname

# this guarentees the state of the node and msd will automatically turn in on
- name: turn off node before flashing
  raw: tpi power off -n {{ node.slot_num }}

- name: switch the mode {{ node_name}} slot {{ node.slot_num }} to disk mode
  raw: tpi advanced msd -n {{ node.slot_num }}

- name: check which block device got created and get its 2nd partition
  raw: ls /dev/sd*2
  register: block_device

- name: extract the block device partition from raw output
  set_fact:
    partition: "{{ block_device.stdout_lines[0] | regex_search('(/dev/sd[a-z]?2)','\\1') | first }}"

- name: mount the block device {{ partition }} into the BMC filesystem
  raw: mkdir -p /mnt/node && mount {{ partition }} /mnt/node

# make minimal changes to the node filesystem so we can reboot and connect to it
- name: modify node filesystem
  raw: |
    set -xe

    # set the hostname
    cd /mnt/node
    echo {{ node_name }} > etc/hostname

    # add ssh keys access for ubuntu user
    keys=home/ubuntu/.ssh; mkdir -p $keys
    echo '{{ public_keys }}' > $keys/authorized_keys
    chown -R 1000:1000 home/ubuntu; chmod 700 $keys; chmod 600 $keys/authorized_keys

    # remove ubuntu password
    sed -i 's/^ubuntu\:[^:]*/ubuntu:*/' etc/shadow
  register: node_modifications

- name: debug - report the modifications made to the node filesystem
  debug:
    var: node_modifications.stdout_lines

- name: unmount the block device
  raw: umount /mnt/node

- name: reboot {{ node_name }} in slot {{ node.slot_num }}
  raw: tpi advanced normal -n {{ node.slot_num }}
