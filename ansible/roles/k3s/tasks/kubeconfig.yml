- name: Read kubeconfig from /etc/rancher/k3s/k3s.yaml
  ansible.builtin.command:
    cmd: cat /etc/rancher/k3s/k3s.yaml
  delegate_to: "{{ cluster_master }}"
  become: true
  register: kube_config
  changed_when: false

- name: Write kubeconfig to $HOME/.kube/config
  ansible.builtin.copy:
    content: "{{ kube_config.stdout | regex_replace('127.0.0.1', cluster_master_ip) }}"
    dest: "$HOME/.kube/config"
    mode: "0600"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  delegate_to: localhost
